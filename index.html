<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Accordion Flow — 1st → 2nd → 3rd</title>
<style>
  :root{
    --bg:#f7fafc;
    --ink:#0e5567;
    --muted:#5b7b86;
    --panel:#ffffff;
    --border:#d9e5ee;
    --accent:#0e5567;
    --chip1:#e4faf6;
    --chip2:#e7f0ff;
    --chip3:#efe7ff;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#0a2b33;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif}
  .wrap{max-width:900px;margin:28px auto 80px;padding:0 14px}
  h1{font-size:20px;margin:0 0 12px}
  p.hint{color:#55737e;margin:0 0 18px}

  /* Controls */
  .controls{display:flex;gap:8px;margin:8px 0 16px}
  .btn{border:1px solid var(--border);background:var(--panel);color:#0a2b33;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,.06)}
  .btn.primary{background:var(--accent);color:#fff;border-color:transparent}

  /* Accordion */
  .section{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  .head{
    display:flex;align-items:center;gap:10px;width:100%;padding:12px 14px;border:0;background:transparent;cursor:pointer;
  }
  .head:hover{background:#f1f6fa}
  .caret{transition:transform .25s ease; width:18px;height:18px;flex:0 0 18px}
  .title{font-weight:800}
  .badge{margin-left:auto;color:#fff;font-size:12px;font-weight:800;padding:4px 8px;border-radius:999px;background:var(--ink)}
  .panel{height:0;overflow:hidden;border-top:1px solid var(--border);background:#fcfeff}
  .panelInner{padding:10px 14px 6px;display:grid;gap:8px}

  /* Node chips inside panels */
  .chip{
    display:flex;align-items:center;gap:8px;
    padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;
    font-weight:800; color:#0a2b33;
  }
  .chip .tag{font-size:11px;font-weight:900;color:var(--muted);background:#eef3f7;border:1px solid var(--border);padding:2px 6px;border-radius:999px}
  .chip.order1{background:var(--chip1)}
  .chip.order2{background:var(--chip2)}
  .chip.order3{background:var(--chip3)}

  /* nested accordion tweaks */
  .subblock{margin-left:8px}
  .empty{color:#7c96a0;font-size:13px;padding:6px 0 2px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Accordion：1st → 2nd → 3rd order</h1>
  <p class="hint">1st 項目をクリック → 関連する 2nd を表示。さらに 2nd をクリック → 関連する 3rd を表示。</p>

  <div class="controls">
    <button class="btn primary" id="expandAll">全て展開</button>
    <button class="btn" id="collapseAll">全て折りたたみ</button>
  </div>

  <!-- ====== ここに自動生成 ====== -->
  <div id="root"></div>
</div>

<script>
/* ===================== データ定義（ご指定の最新フロー） ===================== */
const NODES = {
  // 1st
  "1_prices":         {label:"1. ↓ PRICES", order:1},
  "1_export":         {label:"2. ↑ EXPORT", order:1},
  // 2nd
  "2_1_steelPrice":   {label:"2.1 ↓ STEEL PRICES", order:2},
  "2_2_steelGoods":   {label:"2.2 ↑ STEEL-BASED GOODS", order:2},
  "2_3_exportSq":     {label:"2.3 ↑ EXPORT SQUEEZE", order:2},
  "2_4_detour":       {label:"2.4 ↑ DETOUR TRADE", order:2},
  "2_5_policy":       {label:"2.5 ↑ POLICY PUSHBACK", order:2},
  // 3rd
  "3_1_marketShare":  {label:"3.1 ↓ MARKET SHARE", order:3},
  "3_2_indirectExp":  {label:"3.2 ↑ INDIRECT EXPORTS", order:3},
  "3_3_indirectTrade":{label:"3.3 ↑ INDIRECT TRADE", order:3},
  "3_4_reactionary":  {label:"3.4 ↑ REACTIONARY TRADE", order:3},
};

// edges: from -> to
const EDGES = [
  // 1st → 2nd
  ["1_prices","2_1_steelPrice"],
  ["1_prices","2_2_steelGoods"],
  ["1_export","2_3_exportSq"],
  ["1_export","2_4_detour"],
  ["1_export","2_5_policy"],
  // 2nd → 3rd
  ["2_1_steelPrice","3_1_marketShare"],
  ["2_2_steelGoods","3_1_marketShare"],
  ["2_2_steelGoods","3_2_indirectExp"],
  ["2_3_exportSq","3_1_marketShare"],
  ["2_3_exportSq","3_2_indirectExp"],
  ["2_4_detour","3_3_indirectTrade"],
  ["2_4_detour","3_4_reactionary"],
  ["2_5_policy","3_4_reactionary"],
];

/* ===================== ユーティリティ（隣接リスト） ===================== */
const childrenOf = {};
EDGES.forEach(([a,b])=>{
  if(!childrenOf[a]) childrenOf[a] = [];
  childrenOf[a].push(b);
});
function kids(id){ return (childrenOf[id]||[]).map(k=>NODES[k]); }

/* ===================== DOM 生成 ===================== */
const root = document.getElementById("root");

// 1st セクションを作る
const FIRSTS = ["1_prices","1_export"]; // 表示順
FIRSTS.forEach(fid=>{
  const sec = makeSection(NODES[fid].label, "1st order", "order1");
  const panelInner = sec.querySelector(".panelInner");

  // 2nd のチップ + ネストアコーディオン（3rd）
  (childrenOf[fid]||[]).forEach(sid=>{
    const sub = makeSubSection(NODES[sid].label, "2nd", "order2");
    const subInner = sub.panel;

    const thirdKids = childrenOf[sid]||[];
    if(thirdKids.length===0){
      subInner.appendChild(el("div",{class:"empty",text:"（この項目に 3rd はありません）"}));
    }else{
      thirdKids.forEach(tid=>{
        const chip = makeChip(NODES[tid].label, "order3", "3rd");
        subInner.appendChild(chip);
      });
    }

    panelInner.appendChild(sub.wrap);
  });

  root.appendChild(sec);
});

/* ===================== コンポーネント ===================== */
// 大セクション（1st）: 見出し + パネル
function makeSection(title, badge, orderClass){
  const wrap = el("div",{class:"section"});
  const head = makeHead(title, badge);
  const panel = el("div",{class:"panel"});
  const inner = el("div",{class:"panelInner"});

  panel.appendChild(inner);
  wrap.appendChild(head);
  wrap.appendChild(panel);

  // 初期は閉じる
  setupAccordion(head, panel);
  return wrap;
}

// 2nd（ネスト）: 行ヘッダ + 3rdのチップ群
function makeSubSection(title, badge, orderClass){
  const wrap = el("div",{class:"section subblock"});
  const head = makeHead(title, badge);
  const panel = el("div",{class:"panel"});
  const inner = el("div",{class:"panelInner"});
  panel.appendChild(inner);

  wrap.appendChild(head);
  wrap.appendChild(panel);

  setupAccordion(head, panel);
  return {wrap, panel:inner};
}

// シンプルなチップ
function makeChip(text, orderClass, tag){
  const chip = el("div",{class:`chip ${orderClass}`});
  chip.appendChild(el("span",{class:"tag",text:tag}));
  chip.appendChild(document.createTextNode(" " + text));
  return chip;
}

// 見出し（共通）
function makeHead(title, badgeText){
  const head = el("button",{class:"head", "aria-expanded":"false"});
  head.appendChild(svgCaret());
  head.appendChild(el("span",{class:"title",text:title}));
  head.appendChild(el("span",{class:"badge",text:badgeText}));
  return head;
}

// 開閉ロジック（高さアニメ）
function setupAccordion(head, panel){
  const caret = head.querySelector(".caret");
  const inner = panel.querySelector(".panelInner");

  head.addEventListener("click",()=>{
    const isOpen = head.getAttribute("aria-expanded")==="true";
    if(isOpen){
      collapse(panel, caret, head);
    }else{
      expand(panel, caret, head);
    }
  });

  // 初回は閉じた高さ0に
  panel.style.height = "0px";
}

function expand(panel, caret, head){
  head.setAttribute("aria-expanded","true");
  caret.style.transform = "rotate(90deg)";
  const target = panel.querySelector(".panelInner").scrollHeight;
  panel.style.height = target + "px";
}

function collapse(panel, caret, head){
  head.setAttribute("aria-expanded","false");
  caret.style.transform = "rotate(0deg)";
  panel.style.height = "0px";
}

// SVG caret
function svgCaret(){
  const span = document.createElement("span");
  span.className = "caret";
  span.innerHTML = `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M9 6l8 6-8 6" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--ink').trim()||'#0e5567'}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>`;
  return span;
}

// element helper
function el(tag, props){
  const n = document.createElement(tag);
  if(props){
    Object.entries(props).forEach(([k,v])=>{
      if(k==="text"){ n.textContent = v; }
      else{ n.setAttribute(k,v); }
    });
  }
  return n;
}

/* ===== 全開/全閉 ===== */
document.getElementById("expandAll").addEventListener("click", ()=>{
  document.querySelectorAll(".section > .head").forEach(h=>{
    const panel = h.nextElementSibling;
    const caret = h.querySelector(".caret");
    if(h.getAttribute("aria-expanded")!=="true") expand(panel, caret, h);
  });
  document.querySelectorAll(".subblock > .head").forEach(h=>{
    const panel = h.nextElementSibling;
    const caret = h.querySelector(".caret");
    if(h.getAttribute("aria-expanded")!=="true") expand(panel, caret, h);
  });
});

document.getElementById("collapseAll").addEventListener("click", ()=>{
  document.querySelectorAll(".section > .head, .subblock > .head").forEach(h=>{
    const panel = h.nextElementSibling;
    const caret = h.querySelector(".caret");
    if(h.getAttribute("aria-expanded")==="true") collapse(panel, caret, h);
  });
});

// ウィンドウサイズが変わったとき、開いているパネルの高さを再計算
window.addEventListener("resize", ()=>{
  document.querySelectorAll('.head[aria-expanded="true"]').forEach(h=>{
    const panel = h.nextElementSibling;
    const inner = panel.querySelector(".panelInner");
    panel.style.height = inner.scrollHeight + "px";
  });
});
</script>
</body>
</html>
