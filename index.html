<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Top-Down Flow — Excess Capacity → 1st / 2nd / 3rd（ゆっくり順次）</title>
<style>
  :root{
    --bg:#0f1419;
    --panel:#1c242c;
    --wire:#f4b000;      /* 配線色（オレンジ） */
    --accent1:#f4b000;   /* 1st */
    --accent2:#00b0b9;   /* 2nd */
    --accent3:#bfbfc6;   /* 3rd */
    --ink:#e8eef4;
  }

  html,body{
    height:100%;
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
    overflow-x:hidden; /* 右に寄る原因の横スクロールを抑止 */
  }

  /* 常に中央のカラムに収める */
  .wrap{
    max-width:980px;
    margin:20px auto 120px;
    padding:0 18px;
    position:relative;
  }

  .banner{display:flex;justify-content:center;align-items:center;margin:8px 0 18px}
  .banner span{letter-spacing:.08em;font-weight:900}
  .banner .hi{color:var(--accent1)} .banner .lo{color:#cfd6dc}

  .layers{display:grid;gap:46px;position:relative}
  .layer{position:relative;padding:10px 10px 0}
  .row{
    display:flex;
    gap:18px;
    flex-wrap:wrap;          /* 折り返して中央に寄せる */
    justify-content:center;  /* 常に中央 */
  }

  /* カード */
  .card{
    min-width:260px; max-width:320px;
    background:linear-gradient(180deg,#222b33,#1a222a);
    border:1px solid #2a3640; border-radius:16px;
    padding:16px 16px 14px; position:relative; box-shadow:0 14px 28px rgba(0,0,0,.35);
    display:grid; grid-template-columns:46px 1fr; gap:10px; align-items:center;
    cursor:pointer;                    /* クリック可能 */
  }
  .card.active{ outline:2px solid var(--wire); outline-offset:2px; }

  .card .cap{position:absolute;inset:8px 8px auto 8px;height:8px;border-radius:10px;background:var(--band,#444)}
  .title{font-weight:900}
  .sub{font-size:13px;opacity:.8;margin-top:2px;line-height:1.35}
  .tag{margin-top:6px;font-weight:900;color:#000;background:var(--band,#666);display:inline-block;padding:2px 8px;border-radius:999px}

  /* アイコンバッジ */
  .ico{
    width:46px;height:46px;border-radius:12px;background:#0e1419;
    display:grid;place-items:center;border:1px solid #31404b;
  }
  .ico svg{width:26px;height:26px}

  /* SVG 配線は前面に重ねる */
  .svgLayer{position:absolute;inset:0;pointer-events:none;z-index:5}
  svg{width:100%;height:100%}
  .wire{
    stroke:var(--wire);stroke-width:3.2;fill:none;marker-end:url(#arrow);
    filter:drop-shadow(0 1px 0 rgba(0,0,0,.55));
  }
  .joint{fill:#d8dee6;stroke:#8a949d;stroke-width:1.2}

  .replay{
    position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
    border:0;background:#2b3640;color:#fff;padding:10px 16px;border-radius:12px;
    font-weight:800;cursor:pointer;box-shadow:0 8px 22px rgba(0,0,0,.35)
  }
/* === 2nd / 3rd を横一列に。少しコンパクト化 === */

/* 余裕を持たせて中央カラムを少し広げる */
.wrap{ max-width:1200px; }

/* L2(2nd) と L3(3rd) は折り返さず横並び */
#L2 .row, #L3 .row{
  flex-wrap: nowrap;
  justify-content: center;
  gap:14px;                 /* 隙間を少し詰める */
}

/* カードを少しだけ小ぶりに（横に収めるため） */
#L2 .card{ min-width:220px; padding:14px 14px 12px; }
#L3 .card{ min-width:230px; padding:14px 14px 12px; }

/* アイコンも微縮小 */
#L2 .ico, #L3 .ico{ width:42px; height:42px; }
#L2 .ico svg, #L3 .ico svg{ width:24px; height:24px; }

/* 画面が狭い時は折り返しOK（レスポンシブ） */
@media (max-width: 1100px){
  #L2 .row, #L3 .row{ flex-wrap: wrap; }
}
/* ========== アイコン用ポップオーバー ========== */
.popover {
  position: absolute;
  max-width: 320px;
  width: max(260px, 22vw);
  background: #1c242c;
  color: #e8eef4;
  border: 1px solid #2a3640;
  border-radius: 12px;
  box-shadow: 0 12px 36px rgba(0,0,0,.5);
  padding: 12px 14px;
  z-index: 20;
  pointer-events: auto; /* クリック可能 */
  opacity: 0; transform: translateY(4px); transition: .16s ease;
}
.popover.show { opacity: 1; transform: translateY(0); }

.popover .pop-title { font-weight: 900; margin: 2px 22px 6px 2px; }
.popover .pop-body  { font-size: 14px; line-height: 1.5; opacity: .9; }

.popover .pop-close{
  position:absolute; right:8px; top:6px;
  width:24px; height:24px; border:0; border-radius:6px;
  background:#2b3640; color:#fff; cursor:pointer; font-weight:900;
}

.popover::after{ /* 上向きの三角 */
  content:""; position:absolute; width:0; height:0;
  border-left:8px solid transparent; border-right:8px solid transparent;
  border-top:8px solid #1c242c; bottom:-8px; left:24px;
  filter: drop-shadow(0 1px 0 rgba(0,0,0,.6));
}
.popover[data-pos="above"]::after{  /* 下向きに切り替え */
  border-top:none;
  border-bottom:8px solid #1c242c;
  top:-8px; bottom:auto;
}

  
</style>


</head>
<body>
<div class="wrap" id="wrap">

  <div class="banner">

  </div>

  <div class="layers" id="layers">
    <!-- L0: Start -->
    <div class="layer" id="L0">
      <div class="row">
        <div class="card" id="start" style="--band:var(--accent1)">
          <div class="cap"></div>
          <div class="ico" aria-hidden="true">
            <!-- factory-like capacity -->
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M3 20V9l5 3V9l5 3V8l8 4v8H3Z" stroke="#f4b000" stroke-width="2"/>
              <path d="M6 20v-4m3 4v-4m3 4v-4m3 4v-4m3 4v-4" stroke="#7a8a96" stroke-width="1.5"/>
            </svg>
          </div>
          <div>
            <div class="title">EXCESS CAPACITY</div>
            <div class="sub">in a major market</div>
          </div>
        </div>
      </div>
    </div>

    <!-- L1: 1st order -->
    <div class="layer" id="L1">
      <div class="row">
        <div class="card" id="n1_prices" style="--band:var(--accent1)">
          <div class="cap"></div>
          <div class="ico" aria-hidden="true">
            <!-- price down -->
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M7 4v12m0 0l-3-3m3 3l3-3" stroke="#f4b000" stroke-width="2" stroke-linecap="round"/>
              <circle cx="15" cy="9" r="3.5" stroke="#7a8a96"/>
            </svg>
          </div>
          <div>
            <div class="title">↓ PRICES</div>
            <div class="sub">First-order price reaction</div>
          </div>
        </div>

        <div class="card" id="n1_export" style="--band:var(--accent1)">
          <div class="cap"></div>
          <div class="ico" aria-hidden="true">
            <!-- export/ship -->
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M3 14h8l2-3h8l-2 6H6l-3-3Z" stroke="#f4b000" stroke-width="2"/>
              <path d="M10 6l4 4M14 6l-4 4" stroke="#7a8a96" stroke-width="1.6"/>
            </svg>
          </div>
          <div>
            <div class="title">↑ EXPORT</div>
            <div class="sub">Push to ship out surplus</div>
          </div>
        </div>
      </div>
    </div>

    <!-- L2: 2nd order -->
    <div class="layer" id="L2">
      <div class="row" id="row2">
        <div class="card" id="n21_steelPrice" style="--band:var(--accent2)">
          <div class="cap"></div>
          <div class="ico" aria-hidden="true">
            <!-- steel bar down -->
            <svg viewBox="0 0 24 24" fill="none">
              <rect x="3" y="8" width="14" height="4" rx="2" stroke="#00b0b9" stroke-width="2"/>
              <path d="M20 6v8m0 0l-2-2m2 2l2-2" stroke="#7ad7df" stroke-width="1.6" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <div class="title">↓ STEEL PRICES</div>
          </div>
        </div>

        <div class="card" id="n22_steelGoods" style="--band:var(--accent2)">
          <div class="cap"></div>
          <div class="ico" aria-hidden="true">
            <!-- factory/gear -->
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M3 20v-6l4 2v-3l4 2v-4l6 3v6H3Z" stroke="#00b0b9" stroke-width="2"/>
              <circle cx="18.5" cy="8.5" r="2.5" stroke="#7ad7df"/>
            </svg>
          </div>
          <div>
            <div class="title">↑ STEEL-BASED GOODS</div>
          </div>
        </div>

        <div class="card" id="n23_exportSqueeze" style="--band:var(--accent2)">
          <div class="cap"></div>
          <div class="ico" aria-hidden="true">
            <!-- clamp -->
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M5 6h12v4H5z" stroke="#00b0b9" stroke-width="2"/>
              <path d="M7 10v8m10-8v8" stroke="#7ad7df" stroke-width="2"/>
            </svg>
          </div>
          <div>
            <div class="title">↑ EXPORT SQUEEZE</div>
          </div>
        </div>

        <div class="card" id="n24_detour" style="--band:var(--accent2)">
          <div class="cap"></div>
          <div class="ico" aria-hidden="true">
            <!-- detour arrow -->
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M5 18c8-1 2-10 14-11" stroke="#00b0b9" stroke-width="2"/>
              <path d="M17 5l4 3-4 3" fill="#7ad7df"/>
            </svg>
          </div>
          <div>
            <div class="title">↑ DETOUR TRADE</div>
          </div>
        </div>

        <div class="card" id="n25_policy" style="--band:var(--accent2)">
          <div class="cap"></div>
          <div class="ico" aria-hidden="true">
            <!-- gavel/shield -->
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M4 18h10" stroke="#7ad7df" stroke-width="2"/>
              <path d="M9 6l5 5M11 4l5 5" stroke="#00b0b9" stroke-width="2"/>
              <path d="M16 10l4 4" stroke="#7ad7df" stroke-width="2"/>
            </svg>
          </div>
          <div>
            <div class="title">↑ POLICY PUSHBACK</div>
          </div>
        </div>
      </div>
    </div>

    <!-- L3: 3rd order -->
    <div class="layer" id="L3">
      <div class="row">
        <div class="card" id="n31_marketShare" style="--band:var(--accent3)">
          <div class="cap"></div>
          <div class="ico" aria-hidden="true">
            <!-- pie down -->
            <svg viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="7" stroke="#bfbfc6"/>
              <path d="M12 5v7l5 5" stroke="#bfbfc6" stroke-width="2"/>
            </svg>
          </div>
          <div>
            <div class="title">↓ MARKET SHARE</div>
          </div>
        </div>

        <div class="card" id="n32_indirectExports" style="--band:var(--accent3)">
  <div class="cap"></div>
  <div class="ico" aria-hidden="true" onclick="showTextbox('n32_indirectExports')">
    <!-- car icon -->
    <svg viewBox="0 0 24 24" fill="none" stroke="#bfbfc6" stroke-width="2">
      <rect x="3" y="11" width="18" height="5" rx="1.5"/>
      <circle cx="7" cy="17" r="2"/>
      <circle cx="17" cy="17" r="2"/>
      <path d="M5 11l1.5-4h11L19 11" stroke="#9ea3aa" stroke-width="2"/>
    </svg>
  </div>
  <div>
    <div class="title">↑ INDIRECT EXPORTS</div>
  </div>
</div>



        <div class="card" id="n33_indirectTrade" style="--band:var(--accent3)">
          <div class="cap"></div>
          <div class="ico" aria-hidden="true">
            <!-- globe arrows -->
            <svg viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="7" stroke="#bfbfc6"/>
              <path d="M6 12h12M12 5a12 12 0 010 14" stroke="#9ea3aa"/>
            </svg>
          </div>
          <div>
            <div class="title">↑ TRADE FROM THIRD COUNTRY</div>
          </div>
        </div>

        <div class="card" id="n34_reactionary" style="--band:var(--accent3)">
          <div class="cap"></div>
          <div class="ico" aria-hidden="true">
            <!-- warning -->
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M12 4l9 16H3L12 4Z" stroke="#bfbfc6" stroke-width="2"/>
              <path d="M12 9v5M12 18v.5" stroke="#bfbfc6" stroke-width="2"/>
            </svg>
          </div>
          <div>
            <div class="title">↑ REACTIONARY TRADE</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SVG: コネクタ -->
  <div class="svgLayer">
    <svg id="svg">
      <defs>
        <marker id="arrow" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto">
          <path d="M0,0 L8,4 L0,8" fill="var(--wire)"/>
        </marker>
      </defs>
      <g id="wires"></g>
    </svg>
  </div>

  <button class="replay" id="replay">▶ Again</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
<script>
/* 接続（そのまま） */
const EDGES = [
  ["start","n1_prices"], ["start","n1_export"],
  ["n1_prices","n21_steelPrice"], ["n1_prices","n22_steelGoods"],
  ["n1_export","n23_exportSqueeze"], ["n1_export","n24_detour"], ["n1_export","n25_policy"],
  ["n21_steelPrice","n31_marketShare"],
  ["n22_steelGoods","n31_marketShare"], ["n22_steelGoods","n32_indirectExports"],
  ["n23_exportSqueeze","n31_marketShare"], ["n23_exportSqueeze","n32_indirectExports"],
  ["n24_detour","n33_indirectTrade"], ["n24_detour","n34_reactionary"],
  ["n25_policy","n34_reactionary"]
];

const wrap   = document.getElementById("wrap");
const wiresG = document.getElementById("wires");

/* 既に描画済みのエッジ（累積保持） */
const drawnEdges = new Set();

/* パス生成：下→横→下（終点はカードの手前）。縦区間が潰れないよう保証 */
function elbowPath(fromEl, toEl){
  const wb = wrap.getBoundingClientRect();
  const f  = fromEl.getBoundingClientRect();
  const t  = toEl.getBoundingClientRect();

  const sx = f.left + f.width/2 - wb.left;
  const sy = f.bottom - wb.top + 8;
  const tx = t.left + t.width/2 - wb.left;

  const r  = 10;
  const my = (sy + (t.top - wb.top)) / 2;

  const CLEAR = 10;                 // 先端がカードに潜らない余白
  const MIN_VERTICAL = 8;           // 最後の縦区間の最小長
  const maxTy = t.top - wb.top - 2; // 下がり過ぎ防止
  let ty = t.top - wb.top - CLEAR;
  ty = Math.max(my + r + MIN_VERTICAL, Math.min(maxTy, ty));

  const v1 = `M ${sx} ${sy} L ${sx} ${my-r}`;
  const c1 = `Q ${sx} ${my} ${sx+(tx>sx? r:-r)} ${my}`;
  const h  = `L ${tx-(tx>sx? r:-r)} ${my}`;
  const c2 = `Q ${tx} ${my} ${tx} ${my+r}`;
  const v2 = `L ${tx} ${ty}`;
  return `${v1} ${c1} ${h} ${c2} ${v2}`;
}

/* 1本の矢印を（未描画なら）追加してアニメ表示 */
function addEdgeAnimated(aId, bId){
  const key = `${aId}->${bId}`;
  if (drawnEdges.has(key)) return;          // 既に表示済みなら何もしない
  drawnEdges.add(key);

  const fromEl = document.getElementById(aId);
  const toEl   = document.getElementById(bId);
  if(!fromEl || !toEl) return;

  // path は先にDOMへ追加 → 長さを取得してアニメ
  const p = document.createElementNS("http://www.w3.org/2000/svg","path");
  p.setAttribute("class","wire");
  p.setAttribute("d", elbowPath(fromEl, toEl));
  wiresG.appendChild(p);

  const L = p.getTotalLength ? p.getTotalLength() : 1;
  p.style.strokeDasharray  = L;
  p.style.strokeDashoffset = L;
  gsap.to(p, {strokeDashoffset:0, duration:1.0, ease:"power2.out"});

  // 視認性UPのジョイント
  const wb = wrap.getBoundingClientRect();
  const fa = fromEl.getBoundingClientRect();
  const ta = toEl.getBoundingClientRect();
  const cy = (fa.bottom - wb.top + ta.top - wb.top)/2;
  [ [fa.left+fa.width/2 - wb.left, cy-12],
    [ta.left+ta.width/2 - wb.left, cy+12] ].forEach(([cx,cy2])=>{
      const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("class","joint"); c.setAttribute("cx",cx); c.setAttribute("cy",cy2); c.setAttribute("r","4.2");
      wiresG.appendChild(c);
  });
}

/* 指定カードから出る全エッジを追加（累積） */
function addEdgesFrom(sourceId){
  document.querySelectorAll(".card").forEach(el=>el.classList.remove("active"));
  const src = document.getElementById(sourceId);
  if (src) src.classList.add("active");

  EDGES.filter(([a,_]) => a === sourceId)
       .forEach(([a,b]) => addEdgeAnimated(a,b));
}

/* 再レイアウト時に、累積した線を引き直す */
function redrawAll(){
  const current = Array.from(drawnEdges);
  wiresG.innerHTML = "";
  drawnEdges.clear();
  current.forEach(k=>{
    const [a,b] = k.split("->");
    addEdgeAnimated(a,b);
  });
}

/* 初期化：カードは表示済み、クリックで追加していく */
function init(){
  document.querySelectorAll(".card").forEach(el=>{
    gsap.set(el, {opacity:1, y:0});
    el.addEventListener("click", ()=> addEdgesFrom(el.id));
  });

  // 右下ボタン：全線クリア
  document.getElementById("replay").addEventListener("click", ()=>{
    wiresG.innerHTML = "";
    drawnEdges.clear();
    document.querySelectorAll(".card").forEach(el=>el.classList.remove("active"));
  });

  // 画面サイズ変更やスクロールで再計算（右端に寄る時のズレ対策）
  window.addEventListener("resize", redrawAll, {passive:true});
  window.addEventListener("scroll", redrawAll, {passive:true});
}

init();
const POP_ID = "icon-popover";

/** ポップオーバーを開く（既存があれば置き換え） */
function openPopover(anchorEl, titleText, bodyText){
  closePopover(); // 一旦閉じる

  // ラッパー基準で位置を計算
  const wb = wrap.getBoundingClientRect();
  const r  = anchorEl.getBoundingClientRect();

  // 要素生成
  const pop = document.createElement("div");
  pop.className = "popover";
  pop.id = POP_ID;
  pop.setAttribute("role","dialog");
  pop.setAttribute("aria-modal","false");

  const safeTitle = titleText || "Details";
  const safeBody  = (bodyText && bodyText.trim()) ? bodyText.trim() : "（説明は未設定です）";

  pop.innerHTML = `
    <button class="pop-close" aria-label="閉じる" onclick="closePopover()">×</button>
    <div class="pop-title">${safeTitle}</div>
    <div class="pop-body">${safeBody}</div>
  `;

  // wrap に追加して座標を決める
  wrap.appendChild(pop);

  // デフォルトは「アイコンの下」に出す。スペースがなければ上に。
  const margin = 10;
  const preferBelowTop = r.bottom - wb.top + margin;
  const preferLeft     = r.left   - wb.left;

  // はみ出し補正
  let left = Math.max(8, Math.min(preferLeft, wb.width - pop.offsetWidth - 8));
  let top  = preferBelowTop;

  // 下側にスペースが足りない → 上に出す
  if (top + pop.offsetHeight > wb.height - 8) {
    top = r.top - wb.top - pop.offsetHeight - margin;
    pop.dataset.pos = "above";
  }

  pop.style.left = `${left}px`;
  pop.style.top  = `${top}px`;

  requestAnimationFrame(()=> pop.classList.add("show"));

  // 外側クリック & ESC で閉じる
  document.addEventListener("click", outsideClose, {capture:true});
  document.addEventListener("keydown", escClose);
  function outsideClose(e){
    if (!pop.contains(e.target) && !anchorEl.contains(e.target)) closePopover();
  }
  function escClose(e){ if (e.key === "Escape") closePopover(); }
  // 後始末を保存
  pop._cleanup = ()=>{
    document.removeEventListener("click", outsideClose, {capture:true});
    document.removeEventListener("keydown", escClose);
  };
}

/** ポップオーバーを閉じる */
function closePopover(){
  const pop = document.getElementById(POP_ID);
  if (!pop) return;
  pop.classList.remove("show");
  const cleanup = pop._cleanup;
  setTimeout(()=> { if (cleanup) cleanup(); pop.remove(); }, 120);
}

/** すべての .ico にハンドラ付与（カードクリックに波及しないよう停止） */
function bindIconPopovers(){
  document.querySelectorAll(".ico").forEach(ico=>{
    ico.style.pointerEvents = "auto";
    ico.addEventListener("click", (e)=>{
      e.stopPropagation();                        // 線描画用のカードクリックに伝播させない
      const card  = ico.closest(".card");
      const title = card?.querySelector(".title")?.textContent?.trim() || "";
      const tip   = ico.getAttribute("data-tip") || "";
      openPopover(ico, title, tip);
    });
  });

  // レイアウト変化で位置がズレたら閉じる（簡易対処）
  window.addEventListener("resize", closePopover, {passive:true});
  window.addEventListener("scroll", closePopover, {passive:true});
}

// 既存の init() があればその後に呼ばれるように
if (document.readyState === "loading"){
  document.addEventListener("DOMContentLoaded", bindIconPopovers);
} else {
  bindIconPopovers();
}
</script>



</body>
</html>










