<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Swimlane Flow (1st → 2nd → 3rd) — refined</title>
<style>
  :root{
    --bg:#f6f9fc; --lane:#eaf2fb; --ink:#0e5567;
    --box:#ffffff; --boxText:#082a34; --line:#b9cbe3;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif}
  .wrap{max-width:1200px;margin:24px auto 100px;padding:0 14px;position:relative}
  h1{font-size:18px;margin:0 0 10px}

  /* Swimlanes（← 行間を広く） */
  .lanes{display:grid;grid-template-rows:auto auto auto;gap:42px;position:relative}
  .lane{background:var(--lane);border:1px solid var(--line);border-radius:14px;padding:16px 12px 24px;position:relative}
  .laneTitle{position:absolute;left:14px;top:-12px;background:var(--bg);padding:4px 10px;border:1px solid var(--line);border-radius:10px;font-weight:800}
  .row{display:flex;gap:14px;flex-wrap:wrap;justify-content:flex-start}
  /* 2nd order は必ず横一列（必要なら横スクロール） */
  .row.nowrap{flex-wrap:nowrap;overflow-x:auto;scrollbar-width:thin;scrollbar-color:#b9cbe3 transparent}
  .row.nowrap::-webkit-scrollbar{height:8px}
  .row.nowrap::-webkit-scrollbar-thumb{background:#b9cbe3;border-radius:8px}

  .node{
    min-width:210px; max-width:260px; padding:12px 14px; border-radius:12px;
    background:var(--box); color:var(--boxText); border:1px solid #dfe7f4;
    box-shadow:0 2px 8px rgba(0,0,0,.06);
    font-weight:800; white-space:nowrap; opacity:0; transform:translateY(6px);
    position:relative; z-index:2; /* ← 矢印より前面 */
  }

  /* SVG overlay for connectors */
  .svgLayer{position:absolute; inset:0; pointer-events:none; z-index:1}
  svg{width:100%;height:100%}
  .link{stroke:var(--ink);stroke-width:5.5;fill:none;opacity:.95;marker-end:url(#arrow);
        stroke-dasharray:1;stroke-dashoffset:1}

  .replay{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);border:0;background:var(--ink);color:#fff;padding:10px 16px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 8px 22px rgba(0,0,0,.16)}
</style>
</head>
<body>
<div class="wrap" id="wrap">
  <h1>Swimlane：1st → 2nd → 3rd order</h1>

  <div class="lanes" id="lanes">
    <!-- Lane 1 -->
    <div class="lane" id="lane1">
      <div class="laneTitle">1st order</div>
      <div class="row">
        <div class="node" id="n1_prices">1. ↓ PRICES</div>
        <div class="node" id="n1_export">2. ↑ EXPORT</div>
      </div>
    </div>

    <!-- Lane 2 -->
    <div class="lane" id="lane2">
      <div class="laneTitle">2nd order</div>
      <!-- ★ 横一列固定 -->
      <div class="row nowrap">
        <div class="node" id="n21_steelPrice">2.1 ↓ STEEL PRICES</div>
        <div class="node" id="n22_steelGoods">2.2 ↑ STEEL-BASED GOODS</div>
        <div class="node" id="n23_exportSqueeze">2.3 ↑ EXPORT SQUEEZE</div>
        <div class="node" id="n24_detour">2.4 ↑ DETOUR TRADE</div>
        <div class="node" id="n25_policy">2.5 ↑ POLICY PUSHBACK</div>
      </div>
    </div>

    <!-- Lane 3 -->
    <div class="lane" id="lane3">
      <div class="laneTitle">3rd order</div>
      <div class="row">
        <div class="node" id="n31_marketShare">3.1 ↓ MARKET SHARE</div>
        <div class="node" id="n32_indirectExports">3.2 ↑ INDIRECT EXPORTS</div>
        <div class="node" id="n33_indirectTrade">3.3 ↑ INDIRECT TRADE</div>
        <div class="node" id="n34_reactionary">3.4 ↑ REACTIONARY TRADE</div>
      </div>
    </div>
  </div>

  <!-- connectors -->
  <div class="svgLayer">
    <svg id="svg">
      <defs>
        <!-- ★ 矢印ヘッドを小型化（8px） -->
        <marker id="arrow" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto">
          <path d="M0,0 L8,4 L0,8 Z" fill="#0e5567"/>
        </marker>
      </defs>
      <g id="links"></g>
    </svg>
  </div>

  <button class="replay" id="replay">▶ もう一度再生</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
<script>
/* ===== 接続定義（そのまま） ===== */
const edges = [
  // 1st → 2nd
  ["n1_prices","n21_steelPrice"],
  ["n1_prices","n22_steelGoods"],
  ["n1_export","n23_exportSqueeze"],
  ["n1_export","n24_detour"],
  ["n1_export","n25_policy"],
  // 2nd → 3rd
  ["n21_steelPrice","n31_marketShare"],
  ["n22_steelGoods","n31_marketShare"],
  ["n22_steelGoods","n32_indirectExports"],
  ["n23_exportSqueeze","n31_marketShare"],
  ["n23_exportSqueeze","n32_indirectExports"],
  ["n24_detour","n33_indirectTrade"],
  ["n24_detour","n34_reactionary"],
  ["n25_policy","n34_reactionary"]
];

const wrap = document.getElementById("wrap");
const linksG = document.getElementById("links");

/* 直交配線：下→水平→下
   ★ テキストにかからないよう、始点/終点をボックスから少し離す */
const START_GAP = 6;   // ボックス下から少し離して開始
const END_GAP   = 10;  // 目標ボックス手前で止める（▶がかからない）

function orthPath(fromEl, toEl){
  const wb = wrap.getBoundingClientRect();
  const f = fromEl.getBoundingClientRect();
  const t = toEl.getBoundingClientRect();

  const sx = f.left + f.width/2 - wb.left;
  const sy = f.bottom - wb.top + START_GAP;     // 下方向に少し出してから
  const tx = t.left + t.width/2 - wb.left;
  const ty = t.top - wb.top - END_GAP;          // ★ ボックス手前で止める

  // 中間の水平ライン（上下のちょうど真ん中）
  const midY = (sy + (t.top - wb.top)) / 2;
  const r = 12; // 角の丸み

  const v1 = `M ${sx} ${sy} L ${sx} ${midY - r}`;
  const c1 = `Q ${sx} ${midY} ${sx + (tx>sx? r:-r)} ${midY}`;
  const h  = `L ${tx - (tx>sx? r:-r)} ${midY}`;
  const c2 = `Q ${tx} ${midY} ${tx} ${midY + r}`;
  const v2 = `L ${tx} ${ty}`;
  return `${v1} ${c1} ${h} ${c2} ${v2}`;
}

let pathEls = [];
function drawLinks(){
  linksG.innerHTML = "";
  pathEls = [];
  edges.forEach(([a,b])=>{
    const p = document.createElementNS("http://www.w3.org/2000/svg","path");
    p.setAttribute("class","link");
    p.setAttribute("d", orthPath(document.getElementById(a), document.getElementById(b)));
    linksG.appendChild(p);
    pathEls.push(p);
  });
}

function prep(p){
  const len = p.getTotalLength();
  p.style.strokeDasharray = len;
  p.style.strokeDashoffset = len;
}

// アニメ
const nodeIds = [
  "n1_prices","n1_export",
  "n21_steelPrice","n22_steelGoods","n23_exportSqueeze","n24_detour","n25_policy",
  "n31_marketShare","n32_indirectExports","n33_indirectTrade","n34_reactionary"
];

function play(){
  drawLinks();
  const nodes = nodeIds.map(id=>document.getElementById(id));
  gsap.set(nodes,{opacity:0,y:6});
  pathEls.forEach(prep);

  const tl = gsap.timeline({defaults:{ease:"power2.out"}});
  // Lane1 → Lane2
  tl.to("#n1_prices",{opacity:1,y:0,duration:.45})
    .to(pathEls[0],{strokeDashoffset:0,duration:.7},"<+=0.05")
    .to("#n21_steelPrice",{opacity:1,y:0,duration:.4},"<")
    .to(pathEls[1],{strokeDashoffset:0,duration:.7},"-=0.2")
    .to("#n22_steelGoods",{opacity:1,y:0,duration:.4},"<")

    .to("#n1_export",{opacity:1,y:0,duration:.45},"+=0.1")
    .to(pathEls[2],{strokeDashoffset:0,duration:.7},"<+=0.05")
    .to("#n23_exportSqueeze",{opacity:1,y:0,duration:.4},"<")
    .to(pathEls[3],{strokeDashoffset:0,duration:.7},"-=0.2")
    .to("#n24_detour",{opacity:1,y:0,duration:.4},"<")
    .to(pathEls[4],{strokeDashoffset:0,duration:.7},"-=0.2")
    .to("#n25_policy",{opacity:1,y:0,duration:.4},"<");

  // Lane2 → Lane3
  tl.to(pathEls[5],{strokeDashoffset:0,duration:.7},"+=0.05") // 2.1 → 3.1
    .to("#n31_marketShare",{opacity:1,y:0,duration:.45},"<")
    .to(pathEls[6],{strokeDashoffset:0,duration:.7},"-=0.2")  // 2.2 → 3.1
    .to(pathEls[7],{strokeDashoffset:0,duration:.7},"-=0.2")  // 2.2 → 3.2
    .to("#n32_indirectExports",{opacity:1,y:0,duration:.45},"<")
    .to(pathEls[8],{strokeDashoffset:0,duration:.7},"+=0.05") // 2.3 → 3.1
    .to(pathEls[9],{strokeDashoffset:0,duration:.7},"-=0.2")  // 2.3 → 3.2
    .to(pathEls[10],{strokeDashoffset:0,duration:.7},"-=0.1") // 2.4 → 3.3
    .to("#n33_indirectTrade",{opacity:1,y:0,duration:.45},"<")
    .to(pathEls[11],{strokeDashoffset:0,duration:.7},"-=0.1") // 2.4 → 3.4
    .to("#n34_reactionary",{opacity:1,y:0,duration:.45},"<")
    .to(pathEls[12],{strokeDashoffset:0,duration:.7},"-=0.1"); // 2.5 → 3.4
}

play();
window.addEventListener("resize", drawLinks);
document.getElementById("replay").addEventListener("click", play);
window.addEventListener("keydown", e=>{ if(e.code==="Space") play(); });
</script>
</body>
</html>
