<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>No-cross Swimlane (auto-ordering)</title>
<style>
  :root{
    --bg:#f6f9fc; --lane:#eaf2fb; --ink:#0e5567;
    --box:#ffffff; --boxText:#0a2b33; --line:#b9cbe3;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif}
  .wrap{max-width:1200px;margin:26px auto 110px;padding:0 14px;position:relative}
  h1{font-size:18px;margin:0 0 10px}

  /* Swimlanes（横方向に流れる列） */
  .lanes{display:grid;grid-template-columns:1fr 1fr 1fr;gap:46px;position:relative}
  .lane{background:var(--lane);border:1px solid var(--line);border-radius:14px;padding:22px 16px 22px;position:relative;min-height:520px}
  .laneTitle{position:absolute;left:16px;top:-12px;background:var(--bg);padding:4px 10px;border:1px solid var(--line);border-radius:10px;font-weight:800}
  .col{display:grid;gap:12px;align-content:start}

  .node{
    min-height:48px; padding:12px 14px; border-radius:12px;
    background:var(--box); color:var(--boxText); border:1px solid #dfe7f4;
    box-shadow:0 2px 8px rgba(0,0,0,.06);
    font-weight:800; white-space:nowrap; opacity:0; transform:translateY(6px);
    position:relative; z-index:2; /* 矢印より前面 */
  }

  /* SVGオーバーレイ（コネクタ） */
  .svgLayer{position:absolute; inset:0; pointer-events:none; z-index:1}
  svg{width:100%;height:100%}
  .link{
    stroke:var(--ink); stroke-width:5.2; fill:none; opacity:.95; marker-end:url(#arrow);
    stroke-dasharray:1; stroke-dashoffset:1;
  }
  .replay{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);border:0;background:var(--ink);color:#fff;padding:10px 16px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 8px 22px rgba(0,0,0,.16)}
</style>
</head>
<body>
<div class="wrap" id="wrap">
  <h1>No-cross Swimlane（自動並び替えで矢印が交差しない）</h1>

  <div class="lanes" id="lanes">
    <!-- 1st -->
    <div class="lane">
      <div class="laneTitle">1st order</div>
      <div class="col" id="col1">
        <div class="node" id="n1_prices">1. ↓ PRICES</div>
        <div class="node" id="n1_export">2. ↑ EXPORT</div>
      </div>
    </div>

    <!-- 2nd -->
    <div class="lane">
      <div class="laneTitle">2nd order</div>
      <div class="col" id="col2">
        <div class="node" id="n21_steelPrice">2.1 ↓ STEEL PRICES</div>
        <div class="node" id="n22_steelGoods">2.2 ↑ STEEL-BASED GOODS</div>
        <div class="node" id="n23_exportSqueeze">2.3 ↑ EXPORT SQUEEZE</div>
        <div class="node" id="n24_detour">2.4 ↑ DETOUR TRADE</div>
        <div class="node" id="n25_policy">2.5 ↑ POLICY PUSHBACK</div>
      </div>
    </div>

    <!-- 3rd -->
    <div class="lane">
      <div class="laneTitle">3rd order</div>
      <div class="col" id="col3">
        <div class="node" id="n31_marketShare">3.1 ↓ MARKET SHARE</div>
        <div class="node" id="n32_indirectExports">3.2 ↑ INDIRECT EXPORTS</div>
        <div class="node" id="n33_indirectTrade">3.3 ↑ INDIRECT TRADE</div>
        <div class="node" id="n34_reactionary">3.4 ↑ REACTIONARY TRADE</div>
      </div>
    </div>
  </div>

  <!-- connectors -->
  <div class="svgLayer">
    <svg id="svg">
      <defs>
        <!-- 小さめの矢印ヘッド（6px） -->
        <marker id="arrow" markerWidth="6" markerHeight="6" refX="6" refY="3" orient="auto">
          <path d="M0,0 L6,3 L0,6 Z" fill="#0e5567"/>
        </marker>
      </defs>
      <g id="links"></g>
    </svg>
  </div>

  <button class="replay" id="replay">▶ もう一度再生</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
<script>
/* ===== 元の接続ルール ===== */
const EDGES = [
  // 1st → 2nd
  ["n1_prices","n21_steelPrice"],
  ["n1_prices","n22_steelGoods"],
  ["n1_export","n23_exportSqueeze"],
  ["n1_export","n24_detour"],
  ["n1_export","n25_policy"],
  // 2nd → 3rd
  ["n21_steelPrice","n31_marketShare"],
  ["n22_steelGoods","n31_marketShare"],
  ["n22_steelGoods","n32_indirectExports"],
  ["n23_exportSqueeze","n31_marketShare"],
  ["n23_exportSqueeze","n32_indirectExports"],
  ["n24_detour","n33_indirectTrade"],
  ["n24_detour","n34_reactionary"],
  ["n25_policy","n34_reactionary"]
];

/* ===== 交差ゼロのための並び替え（barycenter） ===== */
function reorderColumn(prevColId, thisColId, edges){
  const prevNodes = Array.from(document.querySelectorAll(`#${prevColId} .node`)).map(n=>n.id);
  const thisNodes = Array.from(document.querySelectorAll(`#${thisColId} .node`));
  const parentIdx = Object.fromEntries(prevNodes.map((id,i)=>[id,i]));

  // 各 thisNode の「親の平均位置」
  const scores = thisNodes.map(n=>{
    const parents = edges.filter(([a,b])=> b===n.id).map(([a])=> parentIdx[a]).filter(i=>i!=null);
    const s = parents.length ? (parents.reduce((p,c)=>p+c,0)/parents.length) : 1e9;
    return {el:n, score:s};
  });

  // スコア順に DOM を並べ替え
  scores.sort((a,b)=>a.score-b.score).forEach(({el})=>{
    el.parentElement.appendChild(el); // 末尾に再挿入＝並び替え
  });
}

// 1→2、2→3 の順に適用
function autoOrder(){
  reorderColumn("col1","col2", EDGES);
  // 2→3 用に 2nd→3rd のエッジだけを渡す
  const e23 = EDGES.filter(([a,b])=> a.startsWith("n2") && b.startsWith("n3"));
  reorderColumn("col2","col3", e23);
}

/* ===== 配線（直交：右→縦→右）。ボックス手前で停止 ===== */
const wrap = document.getElementById("wrap");
const linksG = document.getElementById("links");
const START_GAP = 10, END_GAP = 10, R = 12;

function pathBetween(fromEl, toEl){
  const wb = wrap.getBoundingClientRect();
  const f = fromEl.getBoundingClientRect();
  const t = toEl.getBoundingClientRect();

  const sx = f.right - wb.left + START_GAP;
  const sy = f.top + f.height/2 - wb.top;
  const tx = t.left - wb.left - END_GAP;
  const ty = t.top + t.height/2 - wb.top;

  // 垂直の中間線（左右の中点）
  const mx = (sx + (t.left - wb.left)) / 2;

  const h1 = `M ${sx} ${sy} L ${mx - R} ${sy}`;
  const c1 = `Q ${mx} ${sy} ${mx} ${sy + (ty>sy? R:-R)}`;
  const v  = `L ${mx} ${ty - (ty>sy? R:-R)}`;
  const c2 = `Q ${mx} ${ty} ${mx + R} ${ty}`;
  const h2 = `L ${tx} ${ty}`;
  return `${h1} ${c1} ${v} ${c2} ${h2}`;
}

let pathEls = [];
function drawLinks(){
  linksG.innerHTML = ""; pathEls = [];
  EDGES.forEach(([a,b])=>{
    const p = document.createElementNS("http://www.w3.org/2000/svg","path");
    p.setAttribute("class","link");
    p.setAttribute("d", pathBetween(document.getElementById(a), document.getElementById(b)));
    linksG.appendChild(p); pathEls.push(p);
  });
}

/* ===== アニメ ===== */
function prep(p){ const L=p.getTotalLength(); p.style.strokeDasharray=L; p.style.strokeDashoffset=L; }

const nodeIds = [
  "n1_prices","n1_export",
  "n21_steelPrice","n22_steelGoods","n23_exportSqueeze","n24_detour","n25_policy",
  "n31_marketShare","n32_indirectExports","n33_indirectTrade","n34_reactionary"
];

function play(){
  autoOrder();           // ← まず並び替え
  drawLinks();           // ← その後に配線
  const nodes = nodeIds.map(id=>document.getElementById(id));
  gsap.set(nodes,{opacity:0,y:6});
  pathEls.forEach(prep);

  const tl = gsap.timeline({defaults:{ease:"power2.out"}});
  // 1 → 2
  tl.to("#n1_prices",{opacity:1,y:0,duration:.45})
    .to(pathEls[0],{strokeDashoffset:0,duration:.7},"<+=0.05")
    .to("#n21_steelPrice",{opacity:1,y:0,duration:.4},"<")
    .to(pathEls[1],{strokeDashoffset:0,duration:.7},"-=0.2")
    .to("#n22_steelGoods",{opacity:1,y:0,duration:.4},"<")

    .to("#n1_export",{opacity:1,y:0,duration:.45},"+=0.1")
    .to(pathEls[2],{strokeDashoffset:0,duration:.7},"<+=0.05")
    .to("#n23_exportSqueeze",{opacity:1,y:0,duration:.4},"<")
    .to(pathEls[3],{strokeDashoffset:0,duration:.7},"-=0.2")
    .to("#n24_detour",{opacity:1,y:0,duration:.4},"<")
    .to(pathEls[4],{strokeDashoffset:0,duration:.7},"-=0.2")
    .to("#n25_policy",{opacity:1,y:0,duration:.4},"<");

  // 2 → 3
  tl.to(pathEls[5],{strokeDashoffset:0,duration:.7},"+=0.05") // 2.1 → 3.1
    .to("#n31_marketShare",{opacity:1,y:0,duration:.45},"<")
    .to(pathEls[6],{strokeDashoffset:0,duration:.7},"-=0.2")  // 2.2 → 3.1
    .to(pathEls[7],{strokeDashoffset:0,duration:.7},"-=0.2")  // 2.2 → 3.2
    .to("#n32_indirectExports",{opacity:1,y:0,duration:.45},"<")
    .to(pathEls[8],{strokeDashoffset:0,duration:.7},"+=0.05") // 2.3 → 3.1
    .to(pathEls[9],{strokeDashoffset:0,duration:.7},"-=0.2")  // 2.3 → 3.2
    .to(pathEls[10],{strokeDashoffset:0,duration:.7},"-=0.1") // 2.4 → 3.3
    .to("#n33_indirectTrade",{opacity:1,y:0,duration:.45},"<")
    .to(pathEls[11],{strokeDashoffset:0,duration:.7},"-=0.1") // 2.4 → 3.4
    .to("#n34_reactionary",{opacity:1,y:0,duration:.45},"<")
    .to(pathEls[12],{strokeDashoffset:0,duration:.7},"-=0.1"); // 2.5 → 3.4
}

play();
window.addEventListener("resize", ()=>{ play(); });  // サイズ変更時も並び替え＆再配線
document.getElementById("replay").addEventListener("click", play);
window.addEventListener("keydown", e=>{ if(e.code==="Space") play(); });
</script>
</body>
</html>
