<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Flow: 1st → 2nd → 3rd order (指定ルール版)</title>
<style>
  :root{
    --bg:#f4f8fb;
    --ink:#0e5567;
    --chip:#e0efff;
    --chipText:#0a2b33;
    --accent:#0e5567;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;color:#0a2b33}
  .wrap{max-width:1200px;margin:28px auto 80px;padding:0 16px;position:relative}
  h1{font-size:18px;margin:0 0 12px}
  .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:24px;align-items:start}
  .col{display:grid;gap:12px;position:relative}
  .head{font-weight:800;border:2px solid #000;background:#fff;border-radius:12px;padding:8px 10px;width:max-content}

  /* ノード（右が三角形の“→”シェイプ） */
  .node{--h:48px; --tip:18px;
    display:flex; align-items:center; gap:10px; height:var(--h);
    position:relative; padding:0 18px 0 12px; width:100%;
    background:var(--chip); color:var(--chipText); font-weight:800;
    border-radius:10px 0 0 10px; box-shadow:0 3px 10px rgba(0,0,0,.08);
    opacity:0; transform:translateY(6px);
  }
  .node::after{
    content:""; position:absolute; right:0; top:0;
    border-style:solid;
    border-width:calc(var(--h)/2) 0 calc(var(--h)/2) var(--tip);
    border-color:transparent transparent transparent var(--chip);
  }
  .label{white-space:nowrap}
  .svgLayer{position:absolute; inset:0; pointer-events:none}
  svg{width:100%;height:100%}
  .link{stroke:var(--accent); stroke-width:10; fill:none; opacity:.9;
        stroke-linecap:round; stroke-linejoin:round;
        marker-end:url(#arrowHead);
        stroke-dasharray:1; stroke-dashoffset:1}
  .link.thin{stroke-width:8}
  .replay{position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
    border:0; background:var(--accent); color:#fff; padding:10px 16px;
    border-radius:12px; font-weight:700; cursor:pointer;
    box-shadow:0 8px 22px rgba(0,0,0,.16)}
</style>
</head>
<body>
<div class="wrap" id="wrap">
  <h1>1st → 2nd → 3rd order flow（指定フローに完全準拠）</h1>

  <div class="grid" id="grid">
    <!-- 1st -->
    <div class="col" id="col1">
      <div class="head">1st order impact</div>
      <div class="node" id="n1_prices"><span class="label">1. ↓ PRICES</span></div>
      <div class="node" id="n1_export"><span class="label">2. ↑ EXPORT</span></div>
    </div>

    <!-- 2nd -->
    <div class="col" id="col2">
      <div class="head">2nd order impact</div>
      <div class="node" id="n21_steelPrice"><span class="label">2.1 ↓ STEEL PRICES</span></div>
      <div class="node" id="n22_steelGoods"><span class="label">2.2 ↑ STEEL-BASED GOODS</span></div>
      <div class="node" id="n23_exportSqueeze"><span class="label">2.3 ↑ EXPORT SQUEEZE</span></div>
      <div class="node" id="n24_detour"><span class="label">2.4 ↑ DETOUR TRADE</span></div>
      <div class="node" id="n25_policy"><span class="label">2.5 ↑ POLICY PUSHBACK</span></div>
    </div>

    <!-- 3rd -->
    <div class="col" id="col3">
      <div class="head">3rd order impact</div>
      <div class="node" id="n31_marketShare"><span class="label">3.1 ↓ MARKET SHARE</span></div>
      <div class="node" id="n32_indirectExports"><span class="label">3.2 ↑ INDIRECT EXPORTS</span></div>
      <div class="node" id="n34_reactionary"><span class="label">3.4 ↑ REACTIONARY TRADE</span></div>
    </div>
  </div>

  <!-- 矢印レイヤ -->
  <div class="svgLayer">
    <svg id="svg">
      <defs>
        <marker id="arrowHead" orient="auto" markerWidth="14" markerHeight="14" refX="6" refY="7">
          <path d="M0,0 L14,7 L0,14 Z" fill="var(--accent)"></path>
        </marker>
      </defs>
      <g id="links"></g>
    </svg>
  </div>

  <button class="replay" id="replay">▶ もう一度再生</button>
</div>

<!-- GSAP -->
<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
<script>
/* ===== ノードIDとリンク定義（ご指定フロー） ===== */
const edges = [
  // 1st → 2nd（prices）
  ["n1_prices","n21_steelPrice"],
  ["n1_prices","n22_steelGoods"],
  // 1st → 2nd（export）
  ["n1_export","n23_exportSqueeze"],
  ["n1_export","n24_detour"],
  ["n1_export","n25_policy"],
  // 2nd → 3rd
  ["n21_steelPrice","n31_marketShare"],
  ["n22_steelGoods","n31_marketShare"],
  ["n22_steelGoods","n32_indirectExports"],
  ["n23_exportSqueeze","n31_marketShare"],
  ["n23_exportSqueeze","n32_indirectExports"],
  ["n23_exportSqueeze","n34_reactionary"],
  ["n25_policy","n34_reactionary"],
];

const wrap = document.getElementById("wrap");
const svg = document.getElementById("svg");
const linkGroup = document.getElementById("links");

/* 座標を使ってベジェ曲線を作る（右→左） */
function connectorPath(fromEl, toEl){
  const fb = fromEl.getBoundingClientRect();
  const tb = toEl.getBoundingClientRect();
  const wb = wrap.getBoundingClientRect();

  // 右端中央（from）→ 左端中央（to）
  const x1 = fb.right - wb.left;
  const y1 = fb.top + fb.height/2 - wb.top;
  const x2 = tb.left - wb.left;
  const y2 = tb.top + tb.height/2 - wb.top;

  // 曲率：水平方向の距離の 0.45 を制御点に
  const dx = Math.max(80, (x2 - x1) * 0.45);
  const c1x = x1 + dx, c1y = y1;
  const c2x = x2 - dx, c2y = y2;

  return `M ${x1} ${y1} C ${c1x} ${c1y}, ${c2x} ${c2y}, ${x2} ${y2}`;
}

/* リンクを描画（リサイズにも対応） */
let pathEls = [];
function drawLinks(){
  // 既存クリア
  linkGroup.innerHTML = "";
  pathEls = [];

  edges.forEach(([fromId,toId])=>{
    const fromEl = document.getElementById(fromId);
    const toEl = document.getElementById(toId);
    const p = document.createElementNS("http://www.w3.org/2000/svg","path");
    p.setAttribute("class","link thin");
    p.setAttribute("d", connectorPath(fromEl,toEl));
    linkGroup.appendChild(p);
    pathEls.push(p);
  });
}

/* アニメーション */
function prepDash(p){
  const len = p.getTotalLength();
  p.style.strokeDasharray = len;
  p.style.strokeDashoffset = len;
  return len;
}

const nodeIds = [
  "n1_prices","n1_export",
  "n21_steelPrice","n22_steelGoods","n23_exportSqueeze","n24_detour","n25_policy",
  "n31_marketShare","n32_indirectExports","n34_reactionary"
];

function play(){
  // 初期化
  drawLinks();
  const nodes = nodeIds.map(id=>document.getElementById(id));
  gsap.set(nodes,{opacity:0,y:6});
  pathEls.forEach(prepDash);

  const tl = gsap.timeline({defaults:{ease:"power2.out"}});
  // 1st
  tl.to("#n1_prices",{opacity:1,y:0,duration:.45})
    .to(pathEls[0],{strokeDashoffset:0,duration:.8},"<+=0.05")
    .to("#n21_steelPrice",{opacity:1,y:0,duration:.4},"<")
    .to(pathEls[1],{strokeDashoffset:0,duration:.8},"-=0.2")
    .to("#n22_steelGoods",{opacity:1,y:0,duration:.4},"<")

    .to("#n1_export",{opacity:1,y:0,duration:.45},"+=0.1")
    .to(pathEls[2],{strokeDashoffset:0,duration:.8},"<+=0.05")
    .to("#n23_exportSqueeze",{opacity:1,y:0,duration:.4},"<")
    .to(pathEls[3],{strokeDashoffset:0,duration:.8},"-=0.2")
    .to("#n24_detour",{opacity:1,y:0,duration:.4},"<")
    .to(pathEls[4],{strokeDashoffset:0,duration:.8},"-=0.2")
    .to("#n25_policy",{opacity:1,y:0,duration:.4},"<");

  // 3rd への派生
  // steel price ↓ → market share ↓
  tl.to(pathEls[5],{strokeDashoffset:0,duration:.75},"+=0.05")
    .to("#n31_marketShare",{opacity:1,y:0,duration:.45},"<")
  // steel-based goods ↑ → market share ↓ & indirect exports ↑
    .to(pathEls[6],{strokeDashoffset:0,duration:.75},"-=0.2")
    .to(pathEls[7],{strokeDashoffset:0,duration:.75},"-=0.2")
    .to("#n32_indirectExports",{opacity:1,y:0,duration:.45},"<")
  // export squeeze ↑ → market share ↓, indirect exports ↑, reactionary ↑
    .to(pathEls[8],{strokeDashoffset:0,duration:.7},"+=0.05")
    .to(pathEls[9],{strokeDashoffset:0,duration:.7},"-=0.2")
    .to(pathEls[10],{strokeDashoffset:0,duration:.7},"-=0.2")
    .to("#n34_reactionary",{opacity:1,y:0,duration:.45},"<")
  // policy pushback ↑ → reactionary ↑
    .to(pathEls[11],{strokeDashoffset:0,duration:.7},"-=0.1");
}

play();
window.addEventListener("resize", ()=>{ drawLinks(); }); // レイアウト変更でも再配線
document.getElementById("replay").addEventListener("click", play);
window.addEventListener("keydown", e=>{ if(e.code==="Space") play(); });
</script>
</body>
</html>
