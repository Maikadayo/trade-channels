<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sankey: 1st→2nd→3rd order (animated)</title>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<style>
  html,body{height:100%;margin:0;background:#f6f9fc;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  #chart{width:100%;height:94vh}
  .toolbar{display:flex;gap:8px;align-items:center;justify-content:center;padding:8px}
  button{border:0;background:#0e5567;color:#fff;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.15)}
  button.secondary{background:#6b8790}
</style>
</head>
<body>
<div id="chart"></div>
<div class="toolbar">
  <button id="play">▶ 再生</button>
  <button id="pause" class="secondary">⏸ 一時停止</button>
  <button id="reset" class="secondary">⟲ 最初から</button>
</div>

<script>
/* ========= ノード（左→右：1st / 2nd / 3rd） ========= */
const labels = [
  // 1st (0..1)
  "1. ↓ PRICES",
  "2. ↑ EXPORT",
  // 2nd (2..6)
  "2.1 ↓ STEEL PRICES",
  "2.2 ↑ STEEL-BASED GOODS",
  "2.3 ↑ EXPORT SQUEEZE",
  "2.4 ↑ DETOUR TRADE",
  "2.5 ↑ POLICY PUSHBACK",
  // 3rd (7..10)
  "3.1 ↓ MARKET SHARE",
  "3.2 ↑ INDIRECT EXPORTS",
  "3.3 ↑ INDIRECT TRADE",
  "3.4 ↑ REACTIONARY TRADE"
];

// ノードごとの水平位置（0〜1）
const x = [
  0.03, 0.03,   // 1st
  0.35, 0.35, 0.35, 0.35, 0.35, // 2nd
  0.73, 0.73, 0.73, 0.73  // 3rd
];
// ノードの縦位置（上から0〜1）
const y = [
  0.20, 0.65,
  0.08, 0.25, 0.45, 0.65, 0.85,
  0.15, 0.40, 0.62, 0.85
];

// カラー（レベル別）
const nodeColors = [
  "#2c7a7b","#2c7a7b",          // 1st: teal
  "#3182ce","#3182ce","#3182ce","#3182ce","#3182ce", // 2nd: blue
  "#805ad5","#805ad5","#805ad5","#805ad5"            // 3rd: purple
];

/* ========= リンク定義（ご指定の流れ） ========= */
// s,t は labels 配列のインデックス
const linksAll = {
  source: [
    // 1st→2nd
    0,0,    // 1.PRICES → 2.1,2.2
    1,1,1,  // 2.EXPORT → 2.3,2.4,2.5
    // 2nd→3rd
    2,      // 2.1 → 3.1
    3,3,    // 2.2 → 3.1, 3.2
    4,4,    // 2.3 → 3.1, 3.2
    5,5,    // 2.4 → 3.3, 3.4
    6       // 2.5 → 3.4
  ],
  target: [
    2,3,
    4,5,6,
    7,
    7,8,
    7,8,
    9,10,
    10
  ],
  // すべて 1 としておき、アニメで 0→1 に増やす
  value: new Array(15).fill(1),
  color: new Array(15).fill("rgba(14,85,103,0.55)")
};

// アニメーションの“段階”ごとに値を 0→1 にするフレームを作る
// ステップ: A)1st→2nd(Price) B)1st→2nd(Export) C)2.1/2.2→3.1/3.2 D)2.3→3.1/3.2 E)2.4→3.3/3.4 F)2.5→3.4
const steps = [
  [0,1],          // A
  [2,3,4],        // B
  [5,6,7],        // C
  [8,9],          // D
  [10,11],        // E
  [12]            // F
];

// フレーム生成
function makeFrames(){
  const frames = [];
  let revealed = new Array(linksAll.value.length).fill(0);
  steps.forEach((ids, idx)=>{
    ids.forEach(i=>revealed[i] = 1);
    frames.push({
      name: "step"+idx,
      data: [{
        type: "sankey",
        node: { pad:20, thickness:18 },
        link: {
          source: linksAll.source,
          target: linksAll.target,
          value: revealed.slice(), // 現在までに“開通”したリンクは1、それ以外は0
          color: linksAll.color
        }
      }],
      // スムーズに流量が増えて見えるように遷移時間
      traces: [0],
      layout: {}
    });
  });
  return frames;
}

const data = [{
  type: "sankey",
  orientation: "h",
  node: {
    label: labels,
    x: x, y: y,
    pad: 20, thickness: 18,
    color: nodeColors,
    line: { color: "rgba(0,0,0,0.25)", width: 1 }
  },
  link: {
    source: linksAll.source,
    target: linksAll.target,
    value: new Array(linksAll.value.length).fill(0), // 初期は0
    color: linksAll.color
  }
}];

const layout = {
  margin: {l:10,r:10,t:24,b:10},
  paper_bgcolor: "#f6f9fc",
  plot_bgcolor: "#f6f9fc",
  hovermode: "x",
  font: {size: 13, color:"#0a2b33"},
  // 注釈（レベル見出し）
  annotations: [
    {x:0.03,y:1.03, xref:"paper",yref:"paper", text:"1st order", showarrow:false, font:{size:14,weight:800}},
    {x:0.50,y:1.03, xref:"paper",yref:"paper", text:"2nd order", showarrow:false, font:{size:14}},
    {x:0.97,y:1.03, xref:"paper",yref:"paper", text:"3rd order", showarrow:false, font:{size:14}}
  ],
  updatemenus: [] // 自前のコントローラを使う
};

Plotly.newPlot("chart", data, layout, {displayModeBar:false}).then(g=>{
  const frames = makeFrames();
  Plotly.addFrames("chart", frames);

  // コントロールボタン
  let playing = false;
  let frameIndex = -1;

  function play(){
    playing = true;
    stepForward();
  }
  function pause(){
    playing = false;
  }
  function reset(){
    playing = false;
    frameIndex = -1;
    Plotly.animate("chart", [], {transition:{duration:0}, frame:{duration:0, redraw:true}});
    Plotly.restyle("chart", {"link.value":[new Array(linksAll.value.length).fill(0)]});
  }
  function stepForward(){
    if(!playing) return;
    frameIndex++;
    if(frameIndex >= frames.length){ playing = false; return; }
    Plotly.animate("chart", ["step"+frameIndex], {
      transition: {duration:450, easing:"cubic-in-out"},
      frame: {duration:320, redraw:true}
    }).then(()=>{ setTimeout(stepForward, 160); });
  }

  document.getElementById("play").onclick = ()=>{ if(!playing) play(); };
  document.getElementById("pause").onclick = pause;
  document.getElementById("reset").onclick = reset;

  // クリックで“経路ハイライト”する（選択リンクだけ濃色に）
  const baseColors = linksAll.color.slice();
  document.getElementById("chart").on('plotly_click', ev=>{
    const pts = ev.points?.[0];
    if(!pts || pts.curveNumber !== 0 || pts.pointIndex == null) return;
    const idx = pts.pointIndex;
    const highlight = baseColors.map((c,i)=> i===idx ? "rgba(14,85,103,0.95)" : "rgba(14,85,103,0.25)");
    Plotly.restyle("chart", {"link.color":[highlight]});
    // 1秒後に戻す
    setTimeout(()=> Plotly.restyle("chart", {"link.color":[baseColors]}), 1000);
  });

});
</script>
</body>
</html>
