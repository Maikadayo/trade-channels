<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Flow Diagram (Top-Down) – Excess Capacity → 1st / 2nd / 3rd</title>
<style>
  :root{
    --bg:#0f1419;         /* ダーク背景（添付に寄せた雰囲気） */
    --panel:#1c242c;
    --wire:#f4b000;       /* 配線色：オレンジ */
    --accent1:#f4b000;    /* 1st */
    --accent2:#00b0b9;    /* 2nd */
    --accent3:#bfbfc6;    /* 3rd */
    --ink:#e8eef4;        /* 文字色 */
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif}
  .wrap{max-width:1200px;margin:20px auto 120px;padding:0 18px;position:relative}

  /* 章タイトル（画像の “BEFORE YOU TRADE” 的な帯） */
  .banner{display:flex;justify-content:center;align-items:center;margin:8px 0 18px}
  .banner span{letter-spacing:.08em;font-weight:900}
  .banner .hi{color:var(--accent1)}
  .banner .lo{color:#cfd6dc}

  /* レイヤ（縦方向に並べ、各レイヤでカードを横並び） */
  .layers{display:grid;gap:38px;position:relative}
  .layer{position:relative;padding:10px 10px 0}
  .row{display:flex;gap:18px;flex-wrap:nowrap;justify-content:center}

  /* カード（角丸・立体風） */
  .card{
    min-width:220px; max-width:280px;
    background:linear-gradient(180deg,#222b33,#1a222a);
    border:1px solid #2a3640; border-radius:16px;
    padding:16px 16px 14px; position:relative; box-shadow:0 14px 28px rgba(0,0,0,.35);
  }
  .card .cap{position:absolute;inset:8px 8px auto 8px;height:8px;border-radius:10px;
             background:var(--band,#444)}
  .title{font-weight:900}
  .sub{font-size:13px;opacity:.8;margin-top:6px;line-height:1.35}
  .tag{margin-top:8px;font-weight:900;color:#000;background:var(--band,#666);display:inline-block;padding:2px 8px;border-radius:999px}

  /* SVG 配線 */
  .svgLayer{position:absolute;inset:0;pointer-events:none;z-index:0}
  svg{width:100%;height:100%}
  .wire{stroke:var(--wire);stroke-width:3;fill:none;marker-end:url(#arrow);
        stroke-dasharray:1;stroke-dashoffset:1;filter:drop-shadow(0 1px 0 rgba(0,0,0,.5))}
  .joint{fill:#d8dee6;stroke:#8a949d;stroke-width:1.2}

  .replay{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);border:0;background:#2b3640;color:#fff;padding:10px 16px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 8px 22px rgba(0,0,0,.35)}
</style>
</head>
<body>
<div class="wrap" id="wrap">

  <div class="banner">
    <span class="lo">BEFORE</span>&nbsp;<span class="hi">YOU</span>&nbsp;<span class="lo">ASSESS</span>
  </div>

  <div class="layers" id="layers">
    <!-- L0: Start -->
    <div class="layer" id="L0">
      <div class="row">
        <div class="card" id="start" style="--band:var(--accent1)">
          <div class="cap"></div>
          <div class="title">EXCESS CAPACITY</div>
          <div class="sub">in a major market</div>
          <div class="tag">START</div>
        </div>
      </div>
    </div>

    <!-- L1: 1st order -->
    <div class="layer" id="L1">
      <div class="row">
        <div class="card" id="n1_prices" style="--band:var(--accent1)">
          <div class="cap"></div>
          <div class="title">↓ PRICES</div>
          <div class="sub">First-order price reaction</div>
          <div class="tag">1st</div>
        </div>
        <div class="card" id="n1_export" style="--band:var(--accent1)">
          <div class="cap"></div>
          <div class="title">↑ EXPORT</div>
          <div class="sub">Push to ship out surplus</div>
          <div class="tag">1st</div>
        </div>
      </div>
    </div>

    <!-- L2: 2nd order -->
    <div class="layer" id="L2">
      <div class="row" id="row2">
        <div class="card" id="n21_steelPrice" style="--band:var(--accent2)">
          <div class="cap"></div>
          <div class="title">↓ STEEL PRICES</div>
          <div class="tag">2nd</div>
        </div>
        <div class="card" id="n22_steelGoods" style="--band:var(--accent2)">
          <div class="cap"></div>
          <div class="title">↑ STEEL-BASED GOODS</div>
          <div class="tag">2nd</div>
        </div>
        <div class="card" id="n23_exportSqueeze" style="--band:var(--accent2)">
          <div class="cap"></div>
          <div class="title">↑ EXPORT SQUEEZE</div>
          <div class="tag">2nd</div>
        </div>
        <div class="card" id="n24_detour" style="--band:var(--accent2)">
          <div class="cap"></div>
          <div class="title">↑ DETOUR TRADE</div>
          <div class="tag">2nd</div>
        </div>
        <div class="card" id="n25_policy" style="--band:var(--accent2)">
          <div class="cap"></div>
          <div class="title">↑ POLICY PUSHBACK</div>
          <div class="tag">2nd</div>
        </div>
      </div>
    </div>

    <!-- L3: 3rd order -->
    <div class="layer" id="L3">
      <div class="row">
        <div class="card" id="n31_marketShare" style="--band:var(--accent3)">
          <div class="cap"></div>
          <div class="title">↓ MARKET SHARE</div>
          <div class="tag">3rd</div>
        </div>
        <div class="card" id="n32_indirectExports" style="--band:var(--accent3)">
          <div class="cap"></div>
          <div class="title">↑ INDIRECT EXPORTS</div>
          <div class="tag">3rd</div>
        </div>
        <div class="card" id="n33_indirectTrade" style="--band:var(--accent3)">
          <div class="cap"></div>
          <div class="title">↑ INDIRECT TRADE</div>
          <div class="tag">3rd</div>
        </div>
        <div class="card" id="n34_reactionary" style="--band:var(--accent3)">
          <div class="cap"></div>
          <div class="title">↑ REACTIONARY TRADE</div>
          <div class="tag">3rd</div>
        </div>
      </div>
    </div>
  </div>

  <!-- SVG: コネクタ -->
  <div class="svgLayer">
    <svg id="svg">
      <defs>
        <marker id="arrow" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto">
          <path d="M0,0 L8,4 L0,8" fill="var(--wire)"/>
        </marker>
      </defs>
      <g id="wires"></g>
    </svg>
  </div>

  <button class="replay" id="replay">▶ もう一度再生</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
<script>
/* ------------- 接続（これまで通りの構造） ------------- */
const EDGES = [
  // start → 1st
  ["start","n1_prices"],
  ["start","n1_export"],
  // 1st → 2nd
  ["n1_prices","n21_steelPrice"],
  ["n1_prices","n22_steelGoods"],
  ["n1_export","n23_exportSqueeze"],
  ["n1_export","n24_detour"],
  ["n1_export","n25_policy"],
  // 2nd → 3rd
  ["n21_steelPrice","n31_marketShare"],
  ["n22_steelGoods","n31_marketShare"],
  ["n22_steelGoods","n32_indirectExports"],
  ["n23_exportSqueeze","n31_marketShare"],
  ["n23_exportSqueeze","n32_indirectExports"],
  ["n24_detour","n33_indirectTrade"],
  ["n24_detour","n34_reactionary"],
  ["n25_policy","n34_reactionary"]
];

/* ------------- 直交配線（下→横→下）＆ジョイント ------------- */
const wrap = document.getElementById("wrap");
const wiresG = document.getElementById("wires");

function elbowPath(fromEl, toEl){
  const wb = wrap.getBoundingClientRect();
  const f = fromEl.getBoundingClientRect();
  const t = toEl.getBoundingClientRect();

  const sx = f.left + f.width/2 - wb.left;
  const sy = f.bottom - wb.top + 6;             // カード下から少し下へ
  const tx = t.left + t.width/2 - wb.left;
  const ty = t.top - wb.top - 8;                 // 目的カードの直前で停止
  const my = (sy + (t.top - wb.top)) / 2;        // 中間水平ライン
  const r  = 10;

  const v1 = `M ${sx} ${sy} L ${sx} ${my-r}`;
  const c1 = `Q ${sx} ${my} ${sx+(tx>sx? r:-r)} ${my}`;
  const h  = `L ${tx-(tx>sx? r:-r)} ${my}`;
  const c2 = `Q ${tx} ${my} ${tx} ${my+r}`;
  const v2 = `L ${tx} ${ty}`;
  return `${v1} ${c1} ${h} ${c2} ${v2}`;
}

function draw(){
  wiresG.innerHTML = "";
  EDGES.forEach(([a,b])=>{
    const p = document.createElementNS("http://www.w3.org/2000/svg","path");
    p.setAttribute("class","wire");
    p.setAttribute("d", elbowPath(document.getElementById(a), document.getElementById(b)));
    wiresG.appendChild(p);

    // 途中の小さなジョイント（丸）を2つほど
    const wb = wrap.getBoundingClientRect();
    const fa = document.getElementById(a).getBoundingClientRect();
    const ta = document.getElementById(b).getBoundingClientRect();
    const j1 = document.createElementNS("http://www.w3.org/2000/svg","circle");
    j1.setAttribute("class","joint");
    j1.setAttribute("cx", fa.left + fa.width/2 - wb.left);
    j1.setAttribute("cy", (fa.bottom - wb.top + ta.top - wb.top)/2 - 12);
    j1.setAttribute("r", 4.2);
    const j2 = document.createElementNS("http://www.w3.org/2000/svg","circle");
    j2.setAttribute("class","joint");
    j2.setAttribute("cx", ta.left + ta.width/2 - wb.left);
    j2.setAttribute("cy", (fa.bottom - wb.top + ta.top - wb.top)/2 + 12);
    j2.setAttribute("r", 4.2);
    wiresG.appendChild(j1); wiresG.appendChild(j2);
  });
}

/* ------------- アニメーション ------------- */
function prep(p){ const L=p.getTotalLength(); p.style.strokeDasharray=L; p.style.strokeDashoffset=L; }

function play(){
  draw();
  const cards = Array.from(document.querySelectorAll(".card"));
  gsap.set(cards,{opacity:0,y:8});
  gsap.to(cards,{opacity:1,y:0,stagger:0.06,duration:.45,ease:"power2.out"});

  const wires = Array.from(document.querySelectorAll(".wire"));
  wires.forEach(prep);
  gsap.to(wires,{strokeDashoffset:0,stagger:0.05,duration:.9,ease:"power2.out",delay:.05});
}

play();
window.addEventListener("resize", draw);
document.getElementById("replay").addEventListener("click", play);
</script>
</body>
</html>
